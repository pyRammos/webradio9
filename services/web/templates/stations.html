{% extends "base.html" %}

{% block content %}
<div class="container-fluid h-100">
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
        <div class="container-fluid">
            <a class="navbar-brand" href="{{ url_for('index') }}">
                <i class="fas fa-radio"></i> WebRadio9
            </a>
            <div class="navbar-nav ms-auto">
                <a class="nav-link" href="{{ url_for('logout') }}">
                    <i class="fas fa-sign-out-alt"></i> Logout
                </a>
            </div>
        </div>
    </nav>

    <div class="row h-100">
        <div class="col-md-2 bg-light sidebar">
            <div class="list-group list-group-flush">
                <a href="{{ url_for('index') }}" class="list-group-item list-group-item-action">
                    <i class="fas fa-tachometer-alt"></i> Dashboard
                </a>
                <a href="{{ url_for('stations') }}" class="list-group-item list-group-item-action active">
                    <i class="fas fa-broadcast-tower"></i> Stations
                </a>
                <a href="{{ url_for('recordings') }}" class="list-group-item list-group-item-action">
                    <i class="fas fa-microphone"></i> Recordings
                </a>
                <a href="{{ url_for('podcasts') }}" class="list-group-item list-group-item-action">
                    <i class="fas fa-podcast"></i> Podcasts
                </a>
            </div>
        </div>

        <div class="col-md-5 border-end">
            <div class="p-3">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h5>Radio Stations</h5>
                    <button class="btn btn-primary btn-sm" onclick="showAddStation()">
                        <i class="fas fa-plus"></i> Add Station
                    </button>
                </div>
                <div id="stations-list" class="list-group">
                    <!-- Stations will be loaded here -->
                </div>
            </div>
        </div>

        <div class="col-md-5">
            <div class="p-3">
                <div id="add-station-form" style="display: none;">
                    <h5>Add New Station</h5>
                    <form onsubmit="addStation(event)">
                        <div class="mb-3">
                            <label class="form-label">Station Name</label>
                            <input type="text" class="form-control" id="station-name" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Stream URL</label>
                            <input type="url" class="form-control" id="stream-url" required>
                        </div>
                        <button type="submit" class="btn btn-primary">Add Station</button>
                        <button type="button" class="btn btn-secondary" onclick="hideAddStation()">Cancel</button>
                    </form>
                </div>
                
                <div id="station-details" style="display: none;">
                    <h5 id="station-title"></h5>
                    <div id="station-info"></div>
                    <div class="mt-3">
                        <button class="btn btn-danger btn-sm" onclick="deleteStation()">
                            <i class="fas fa-trash"></i> Delete
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
let selectedStationId = null;

function loadStations() {
    fetch('/api/stations')
        .then(response => response.json())
        .then(stations => {
            const list = document.getElementById('stations-list');
            list.innerHTML = '';
            
            stations.forEach(station => {
                const item = document.createElement('div');
                item.className = 'list-group-item list-group-item-action';
                item.onclick = () => selectStation(station);
                
                const statusIcon = station.is_valid ? 
                    '<i class="fas fa-check-circle text-success"></i>' : 
                    '<i class="fas fa-exclamation-circle text-warning"></i>';
                
                item.innerHTML = `
                    <div class="d-flex w-100 justify-content-between">
                        <h6 class="mb-1">${station.name} ${statusIcon}</h6>
                    </div>
                    <p class="mb-1">${station.stream_url}</p>
                `;
                
                list.appendChild(item);
            });
        });
}

function selectStation(station) {
    selectedStationId = station.id;
    document.getElementById('station-title').textContent = station.name;
    
    const info = document.getElementById('station-info');
    info.innerHTML = `
        <div class="mb-3">
            <h6 class="text-primary border-bottom pb-1 mb-2"><i class="fas fa-link me-2"></i>Connection Details</h6>
            <p><strong>URL:</strong> ${station.stream_url}</p>
            <p><strong>Status:</strong> ${station.is_valid ? '<span class="text-success">Valid</span>' : '<span class="text-warning">Invalid</span>'}</p>
        </div>
        
        <div class="mb-3">
            <h6 class="text-primary border-bottom pb-1 mb-2"><i class="fas fa-music me-2"></i>Media Information</h6>
            ${station.format ? `<p><strong>Format:</strong> ${station.format.toUpperCase()}</p>` : '<p><strong>Format:</strong> <span class="text-muted">Unknown</span></p>'}
            ${station.bitrate ? `<p><strong>Bitrate:</strong> ${station.bitrate} kbps</p>` : '<p><strong>Bitrate:</strong> <span class="text-muted">Unknown</span></p>'}
            ${station.sample_rate ? `<p><strong>Sample Rate:</strong> ${station.sample_rate} Hz</p>` : '<p><strong>Sample Rate:</strong> <span class="text-muted">Unknown</span></p>'}
            ${station.channels ? `<p><strong>Channels:</strong> ${station.channels === 1 ? 'Mono' : station.channels === 2 ? 'Stereo' : station.channels}</p>` : '<p><strong>Channels:</strong> <span class="text-muted">Unknown</span></p>'}
            ${station.codec ? `<p><strong>Codec:</strong> ${station.codec}</p>` : '<p><strong>Codec:</strong> <span class="text-muted">Unknown</span></p>'}
        </div>
        
        ${station.metadata ? `
        <div class="mb-3">
            <h6 class="text-primary border-bottom pb-1 mb-2"><i class="fas fa-info-circle me-2"></i>Stream Metadata</h6>
            <p><strong>Server:</strong> ${station.metadata.server || '<span class="text-muted">Unknown</span>'}</p>
            <p><strong>Content Type:</strong> ${station.metadata.content_type || '<span class="text-muted">Unknown</span>'}</p>
        </div>` : ''}
    `;
    
    document.getElementById('add-station-form').style.display = 'none';
    document.getElementById('station-details').style.display = 'block';
}

function showAddStation() {
    document.getElementById('add-station-form').style.display = 'block';
    document.getElementById('station-details').style.display = 'none';
}

function hideAddStation() {
    document.getElementById('add-station-form').style.display = 'none';
    document.getElementById('station-name').value = '';
    document.getElementById('stream-url').value = '';
}

function addStation(event) {
    event.preventDefault();
    
    const data = {
        name: document.getElementById('station-name').value,
        stream_url: document.getElementById('stream-url').value
    };
    
    fetch('/api/stations', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify(data)
    })
    .then(response => response.json())
    .then(result => {
        if (result.success) {
            hideAddStation();
            setTimeout(loadStations, 1000); // Reload after validation
        }
    });
}

function deleteStation() {
    if (!selectedStationId) return;
    
    if (confirm('Are you sure you want to delete this station?')) {
        fetch(`/api/stations/${selectedStationId}`, {method: 'DELETE'})
            .then(() => {
                loadStations();
                document.getElementById('station-details').style.display = 'none';
            });
    }
}

// Load stations on page load
loadStations();
</script>
{% endblock %}
