{% extends "base.html" %}

{% block content %}
<div class="container-fluid h-100">
    <!-- Top Navigation -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
        <div class="container-fluid">
            <a class="navbar-brand" href="#">
                <i class="fas fa-radio"></i> WebRadio9
            </a>
            <div class="navbar-nav ms-auto">
                <a class="nav-link" href="{{ url_for('logout') }}">
                    <i class="fas fa-sign-out-alt"></i> Logout
                </a>
            </div>
        </div>
    </nav>

    <div class="row h-100">
        <!-- Left Sidebar -->
        <div class="col-md-2 bg-light sidebar">
            <div class="list-group list-group-flush">
                <a href="{{ url_for('index') }}" class="list-group-item list-group-item-action active">
                    <i class="fas fa-tachometer-alt"></i> Dashboard
                </a>
                <a href="{{ url_for('stations') }}" class="list-group-item list-group-item-action">
                    <i class="fas fa-broadcast-tower"></i> Stations
                </a>
                <a href="{{ url_for('recordings') }}" class="list-group-item list-group-item-action">
                    <i class="fas fa-microphone"></i> Recordings
                </a>
                <a href="{{ url_for('podcasts') }}" class="list-group-item list-group-item-action">
                    <i class="fas fa-podcast"></i> Podcasts
                </a>
                <a href="{{ url_for('logs') }}" class="list-group-item list-group-item-action">
                    <i class="fas fa-file-alt"></i> Logs
                </a>
                <a href="{{ url_for('services') }}" class="list-group-item list-group-item-action">
                    <i class="fas fa-cogs"></i> Services
                </a>
            </div>
        </div>

        <!-- Middle Pane -->
        <div class="col-md-5 border-end">
            <div class="p-3">
                <h5>Recent Recordings</h5>
                <div id="recent-recordings" class="list-group">
                    <!-- Recent recordings will be loaded here -->
                </div>
            </div>
        </div>

        <!-- Right Pane -->
        <div class="col-md-5">
            <div class="p-3">
                <h5>System Health</h5>
                <div class="card mb-3">
                    <div class="card-body">
                        <div id="service-status">
                            <!-- Service status will be loaded here -->
                        </div>
                    </div>
                </div>
                
                <h5>System Status</h5>
                <div class="card mb-3">
                    <div class="card-body">
                        <p class="card-text">WebRadio9 is running and ready to record radio streams.</p>
                        <a href="{{ url_for('recordings') }}" class="btn btn-primary btn-sm">
                            <i class="fas fa-plus"></i> New Recording
                        </a>
                        <a href="{{ url_for('stations') }}" class="btn btn-outline-primary btn-sm">
                            <i class="fas fa-broadcast-tower"></i> Manage Stations
                        </a>
                    </div>
                </div>
                
                <h6>Quick Stats</h6>
                <div id="stats" class="row">
                    <div class="col-6">
                        <div class="card text-center">
                            <div class="card-body">
                                <h5 id="stations-count">-</h5>
                                <small>Stations</small>
                            </div>
                        </div>
                    </div>
                    <div class="col-6">
                        <div class="card text-center">
                            <div class="card-body">
                                <h5 id="recordings-count">-</h5>
                                <small>Recordings</small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
function loadDashboard() {
    // Load service status
    loadServiceStatus();
    
    // Load recent recordings
    fetch('/api/recordings')
        .then(response => response.json())
        .then(recordings => {
            const list = document.getElementById('recent-recordings');
            list.innerHTML = '';
            
            if (recordings.length === 0) {
                list.innerHTML = `
                    <div class="list-group-item">
                        <p class="mb-1">No recordings yet</p>
                        <small>Start by adding a radio station and scheduling a recording.</small>
                    </div>
                `;
            } else {
                recordings.slice(0, 5).forEach(recording => {
                    const item = document.createElement('div');
                    item.className = 'list-group-item';
                    
                    const statusBadge = getStatusBadge(recording.status);
                    const startTime = recording.start_time ? 
                        new Date(recording.start_time).toLocaleString('en-GB') : 'Not set';
                    
                    item.innerHTML = `
                        <div class="d-flex w-100 justify-content-between">
                            <h6 class="mb-1">${recording.name} ${statusBadge}</h6>
                            <small>${startTime}</small>
                        </div>
                    `;
                    
                    list.appendChild(item);
                });
            }
            
            document.getElementById('recordings-count').textContent = recordings.length;
        });
    
    // Load stations count
    fetch('/api/stations')
        .then(response => response.json())
        .then(stations => {
            document.getElementById('stations-count').textContent = stations.length;
        });
}

function loadServiceStatus() {
    fetch('/api/system/health')
        .then(response => response.json())
        .then(services => {
            const container = document.getElementById('service-status');
            container.innerHTML = '';
            
            services.forEach(service => {
                const statusIcon = service.status === 'running' ? 
                    '<i class="fas fa-check-circle text-success"></i>' : 
                    '<i class="fas fa-times-circle text-danger"></i>';
                
                const statusText = service.status === 'running' ? 'Running' : 'Stopped';
                const statusClass = service.status === 'running' ? 'text-success' : 'text-danger';
                
                const serviceDiv = document.createElement('div');
                serviceDiv.className = 'd-flex justify-content-between align-items-center py-1';
                serviceDiv.innerHTML = `
                    <span><i class="fas fa-${getServiceIcon(service.name)} me-2"></i>${service.name}</span>
                    <span class="${statusClass}">${statusIcon} ${statusText}</span>
                `;
                container.appendChild(serviceDiv);
            });
        })
        .catch(error => {
            document.getElementById('service-status').innerHTML = 
                '<div class="text-danger"><i class="fas fa-exclamation-triangle"></i> Unable to check service status</div>';
        });
}

function getServiceIcon(serviceName) {
    const icons = {
        'Web': 'globe',
        'Station': 'broadcast-tower',
        'Scheduler': 'clock',
        'Recording': 'microphone',
        'Storage': 'hdd',
        'Notification': 'bell',
        'Podcast': 'podcast'
    };
    return icons[serviceName] || 'cog';
}

function getStatusBadge(status) {
    const badges = {
        'SCHEDULED': '<span class="badge bg-primary">Scheduled</span>',
        'RECORDING': '<span class="badge bg-warning">Recording</span>',
        'COMPLETE': '<span class="badge bg-success">Complete</span>',
        'PARTIAL': '<span class="badge bg-info">Partial</span>',
        'FAILED': '<span class="badge bg-danger">Failed</span>'
    };
    return badges[status] || '';
}

// Load dashboard data
loadDashboard();
setInterval(loadDashboard, 30000); // Refresh every 30 seconds
</script>
    </div>
</div>
{% endblock %}
